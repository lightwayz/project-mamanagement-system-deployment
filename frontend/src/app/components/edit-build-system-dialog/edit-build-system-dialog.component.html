<div class="edit-build-system-dialog">
  <div class="dialog-header">
    <mat-icon class="header-icon">edit</mat-icon>
    <h2>Edit Build System</h2>
    <button mat-icon-button (click)="onCancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div class="dialog-content">
    <mat-stepper #stepper orientation="horizontal" linear="false" class="build-system-stepper">
      <!-- Step 1: Basic Information -->
      <mat-step [stepControl]="basicInfoForm" label="Basic Information">
        <form [formGroup]="basicInfoForm" class="step-content">
          <div class="form-section">
            <h3>
              <mat-icon>info</mat-icon>
              System Information
            </h3>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>System Name</mat-label>
                <input matInput formControlName="name" placeholder="Enter build system name">
                <mat-error *ngIf="basicInfoForm.get('name')?.errors?.['required']">
                  System name is required
                </mat-error>
                <mat-error *ngIf="basicInfoForm.get('name')?.errors?.['maxlength']">
                  Name cannot exceed 255 characters
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="form-field">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" rows="3"
                         placeholder="Describe the build system purpose and configuration"></textarea>
                <mat-error *ngIf="basicInfoForm.get('description')?.errors?.['maxlength']">
                  Description cannot exceed 1000 characters
                </mat-error>
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-checkbox formControlName="is_active" class="status-checkbox">
                <span class="checkbox-label">System is Active</span>
                <span class="checkbox-description">Active systems can be used in projects</span>
              </mat-checkbox>
            </div>
          </div>

          <div class="step-actions">
            <button mat-raised-button color="primary" matStepperNext [disabled]="!basicInfoForm.valid">
              <mat-icon>arrow_forward</mat-icon>
              Continue to Locations
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 2: Locations & Devices -->
      <mat-step [stepControl]="locationsForm" label="Locations & Devices">
        <form [formGroup]="locationsForm" class="step-content">
          <div class="form-section">
            <div class="section-header">
              <h3>
                <mat-icon>location_on</mat-icon>
                Configure Locations
              </h3>
              <button mat-raised-button color="accent" (click)="addLocation()" type="button">
                <mat-icon>add</mat-icon>
                Add Location
              </button>
            </div>

            <div formArrayName="locations" class="locations-container">
              <mat-card *ngFor="let location of locationsArray.controls; let i = index"
                       [formGroupName]="i" class="location-card">
                <mat-card-header>
                  <mat-card-title>
                    <mat-icon class="location-icon">room</mat-icon>
                    Location {{ i + 1 }}
                    <span class="location-cost">{{ formatCurrency(getLocationCost(i)) }}</span>
                  </mat-card-title>
                  <button mat-icon-button (click)="removeLocation(i)"
                         [disabled]="locationsArray.length <= 1"
                         class="remove-location-btn" type="button">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-card-header>

                <mat-card-content>
                  <div class="location-form">
                    <div class="form-row">
                      <mat-form-field appearance="outline" class="location-name-field">
                        <mat-label>Location Name</mat-label>
                        <input matInput formControlName="name" placeholder="e.g., Living Room">
                        <mat-error *ngIf="location.get('name')?.errors?.['required']">
                          Location name is required
                        </mat-error>
                      </mat-form-field>
                    </div>

                    <div class="form-row">
                      <mat-form-field appearance="outline" class="location-description-field">
                        <mat-label>Description (Optional)</mat-label>
                        <textarea matInput formControlName="description" rows="2"
                                 placeholder="Describe this location"></textarea>
                      </mat-form-field>
                    </div>

                    <!-- Device Selection -->
                    <div class="device-selection">
                      <h4>
                        <mat-icon>devices</mat-icon>
                        Equipment Selection
                      </h4>

                      <div class="device-search">
                        <mat-form-field appearance="outline" class="search-field">
                          <mat-label>Search Devices</mat-label>
                          <input matInput #searchInput (input)="filterDevices(searchInput.value)"
                                placeholder="Search by name, brand, or category">
                          <mat-icon matPrefix>search</mat-icon>
                        </mat-form-field>
                      </div>

                      <div class="devices-grid" *ngIf="!loadingDevices">
                        <div *ngFor="let device of filteredDevices.slice(0, 6)"
                             class="device-item"
                             (click)="addDeviceToLocation(i, device)">
                          <div class="device-info">
                            <div class="device-name">{{ device.name }}</div>
                            <div class="device-details">{{ device.brand }} â€¢ {{ device.category }}</div>
                            <div class="device-price">{{ formatCurrency(device.selling_price) }}</div>
                          </div>
                          <mat-icon class="add-icon">add_circle</mat-icon>
                        </div>
                      </div>

                      <div *ngIf="loadingDevices" class="loading-devices">
                        <mat-spinner diameter="30"></mat-spinner>
                        <span>Loading devices...</span>
                      </div>

                      <!-- Selected Devices -->
                      <div formArrayName="devices" class="selected-devices"
                           *ngIf="getLocationDevicesArray(i).length > 0">
                        <h5>Selected Equipment:</h5>
                        <div *ngFor="let device of getLocationDevicesArray(i).controls; let j = index"
                             [formGroupName]="j" class="selected-device">
                          <div class="device-details">
                            <div class="device-name">{{ getDeviceById(device.get('device_id')?.value)?.name }}</div>
                            <div class="device-brand">{{ getDeviceById(device.get('device_id')?.value)?.brand }}</div>
                          </div>
                          <div class="device-controls">
                            <mat-form-field appearance="outline" class="quantity-field">
                              <mat-label>Qty</mat-label>
                              <input matInput type="number" formControlName="quantity" min="1">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="price-field">
                              <mat-label>Unit Price</mat-label>
                              <input matInput type="number" formControlName="unit_price" min="0" step="0.01">
                            </mat-form-field>
                            <button mat-icon-button (click)="removeDeviceFromLocation(i, j)"
                                   class="remove-device-btn" type="button">
                              <mat-icon>remove_circle</mat-icon>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button mat-raised-button color="primary" matStepperNext>
              <mat-icon>arrow_forward</mat-icon>
              Review & Save
            </button>
          </div>
        </form>
      </mat-step>

      <!-- Step 3: Review -->
      <mat-step label="Review & Save">
        <div class="step-content">
          <div class="review-section">
            <h3>
              <mat-icon>preview</mat-icon>
              Review Build System
            </h3>

            <mat-card class="review-card">
              <mat-card-content>
                <div class="review-summary">
                  <div class="summary-item">
                    <span class="label">System Name:</span>
                    <span class="value">{{ basicInfoForm.get('name')?.value }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="label">Status:</span>
                    <mat-chip-set>
                      <mat-chip [class]="basicInfoForm.get('is_active')?.value ? 'status-active' : 'status-inactive'">
                        {{ basicInfoForm.get('is_active')?.value ? 'Active' : 'Inactive' }}
                      </mat-chip>
                    </mat-chip-set>
                  </div>
                  <div class="summary-item">
                    <span class="label">Locations:</span>
                    <span class="value">{{ locationsArray.length }}</span>
                  </div>
                  <div class="summary-item">
                    <span class="label">Total Cost:</span>
                    <span class="value cost">{{ formatCurrency(totalCost) }}</span>
                  </div>
                </div>

                <div class="description-review" *ngIf="basicInfoForm.get('description')?.value">
                  <strong>Description:</strong>
                  <p>{{ basicInfoForm.get('description')?.value }}</p>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <div class="step-actions">
            <button mat-button matStepperPrevious>
              <mat-icon>arrow_back</mat-icon>
              Back to Locations
            </button>
            <button mat-raised-button color="primary" (click)="onSubmit()" [disabled]="loading">
              <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
              <mat-icon *ngIf="!loading">save</mat-icon>
              {{ loading ? 'Updating...' : 'Update Build System' }}
            </button>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  </div>

  <div class="dialog-actions">
    <button mat-button (click)="onCancel()" [disabled]="loading">
      <mat-icon>cancel</mat-icon>
      Cancel
    </button>
  </div>
</div>